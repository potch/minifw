import{Server as t}from"node:http";import{readFile as e}from"node:fs/promises";import s from"./router.js";const r=(t,e)=>t instanceof RegExp?t:e;export default class extends t{constructor({host:t=new URL("http://localhost:8080/"),routes:e=[]}={}){super(((t,e)=>this.handler(t,e).catch(console.error))),Object.assign(this,s({routes:e}),{host:t})}async handler(t,s){t.url=new URL(t.url,this.host);const{pathname:r}=t.url,o=[],n=t.method+":"+r,a=this.route(n);t.body=new Promise((e=>{t.on("data",(t=>o.push(t))),t.on("end",(()=>e(Buffer.concat(o))))})),s.sendFile=(t,r)=>(s.setHeader("content-type",r??"text/plain"),e(t).then((t=>s.end(t.toString("utf8")))));for(let{handler:e,params:r}of a)if(t.params=r,await(e?.(t,s)),s.writableEnded)return}get(t,e){this.handle(r(t,"GET:"+t),e)}post(t,e){this.handle(r(t,"POST:"+t),e)}listen(){return new Promise((t=>super.listen(this.host.port,(()=>t(this)))))}}
